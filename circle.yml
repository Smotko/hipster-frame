machine:
  python:
    version: 3.5.2

general:
  artifacts:
    - "frontend/coverage"
    - "api/htmlcov"

dependencies:
  cache_directories:
    - "frontend/node_modules"
  override:
    - npm install:
        pwd:
          frontend
    - pip install -r requirements.txt:
        pwd:
          api

test:
  override:
    - mkdir $CIRCLE_TEST_REPORTS/{api,frontend}
    - npm test -- --coverage:
        pwd:
          frontend
        environment:
          CI: true
    - "coverage run src/test.py && coverage report && coverage html && coverage xml":
        pwd:
          api
        environment:
          DB_PASSWORD: postgres
          DB_USERNAME: postgres
          DB_HOST: db9
          DB_PORT: 5432
          CLIENT_ID: 007
          CLIENT_SECRET: agent
          REDIRECT_URI: "http://localhost:8080/api/instagram/callback"
          SECRET_KEY: shaken
          SERVER_URI: "http://localhost:8080"
    - mv api/reports/* $CIRCLE_TEST_REPORTS/api
  post:
    - bash <(curl -s https://codecov.io/bash) -X gcov -X coveragepy -f /home/ubuntu/hipster-frame/frontend/coverage/clover.xml -f /home/ubuntu/hipster-frame/api/coverage.xml -t $CODECOV_TOKEN
